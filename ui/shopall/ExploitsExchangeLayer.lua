-- FileName: ExploitsExchangeLayer.lua
-- Author: bzx
-- Date: 15-04-02
-- Purpose: 战功兑换

module("ExploitsExchangeLayer", package.seeall)

require "script/libs/LuaCC"
require "script/ui/tip/AnimationTip"
require "script/libs/LuaCCLabel"
require "db/DB_GroupCopy_shop"
require "script/ui/guildBossCopy/GuildBossCopyService"
require "script/ui/guildBossCopy/GuildBossCopyData"
require "script/ui/main/BulletinLayer"  --上面的通知栏
require "script/ui/main/MenuLayer"  --下面的菜单栏
local _layer
local _priority
local _zOrder
local _tableView
local _exploitsLabel
local _cellSize
local _centerLayer
local _centerSize   = nil
local _isShow = false
local _viewBgSprite = nil

function init()
    _tableView = nil
    _exploitsLabel = nil
    _cellSize = CCSizeMake(435,178)
    -- _layer    = nil
end


function show(p_touchPriority, p_zOrder)
    local layer = create(p_touchPriority, p_zOrder)
    local curScene = MainScene:getOnRunningLayer()
    curScene:addChild(layer, _zOrder)
end

function createCenterLayer(p_centerLayerSizse, p_touchPriority, p_zOrder, p_isShow)
    init()
    _priority = p_touchPriority or -700
    _isShow = p_isShow or false
    _zOrder = p_zOrder or 10
    _centerSize = p_centerLayerSizse
    _centerLayer = CCLayer:create()
    _centerLayer:setContentSize(_centerSize)
    loadBg()
    GuildBossCopyService.getShopInfo(getUserInfoCallFunc)
    return _centerLayer
end

function create(p_touchPriority, p_zOrder)
    
    _priority = p_touchPriority or -700
    _zOrder = p_zOrder or 10
    require "script/ui/shopall/ShoponeLayer"
    _layer = LuaCCSprite.createMaskLayer(ccc4(0, 0, 0, 200), p_touchPriority)
    local centerLayer = createCenterLayer(ShoponeLayer.getCenterSize(), p_touchPriority, _zOrder, true)
    _layer:addChild(centerLayer)
    centerLayer:ignoreAnchorPointForPosition(false)
    centerLayer:setAnchorPoint(ccp(0.5, 0.5))
    centerLayer:setPosition(ccpsprite(0.5, 0.5, _layer))
    loadMenu() -- 返回按钮
    return _layer
end


function getUserInfoCallFunc( ... )
    local getShopInfoCallFunc = function ( ... )
        loadTableView()
        refreshExploitsLabel()
    end
    GuildBossCopyService.getUserInfo(getShopInfoCallFunc)
end

function loadBg( ... )
    if not _isShow then
        --背景
        local underLayer = CCScale9Sprite:create("images/barn/under_hong.png")
        underLayer:setContentSize(_centerSize)
        underLayer:setAnchorPoint(ccp(0,0))
        underLayer:setPosition(ccp(0,0))
        _centerLayer:addChild(underLayer)

        --上波浪
        local up = CCSprite:create("images/match/shang.png")
        up:setAnchorPoint(ccp(0,1))
        up:setPosition(ccp(0, _centerSize.height))
        up:setScale(g_fScaleX)
        underLayer:addChild(up)
        --下波浪
        local down = CCSprite:create("images/match/xia.png")
        down:setPosition(ccp(0,0))
        down:setScale(g_fScaleX)
        underLayer:addChild(down)
    end
    --小镁铝
    local girlSprite = CCSprite:create("images/shop/shopall/zhangong.png")
    girlSprite:setAnchorPoint(ccp(0, 0.5))
    girlSprite:setPosition(ccp(0, _centerSize.height * 0.5))
    girlSprite:setScale(g_fElementScaleRatio)
    _centerLayer:addChild(girlSprite)

    --活动标题
    local titleSprite = CCSprite:create("images/barn/shopName.png")
    titleSprite:setAnchorPoint(ccp(0.5,1))
    titleSprite:setPosition(ccp(g_winSize.width * 0.5, _centerSize.height))
    _centerLayer:addChild(titleSprite)
    titleSprite:setScale(g_fElementScaleRatio)
end

function loadMenu( ... )
    --menu层
    local bgMenu = CCMenu:create()
    bgMenu:setAnchorPoint(ccp(0,0))
    bgMenu:setPosition(ccp(0,0))
    -- bgMenu:setScale(g_fScaleX)
    bgMenu:setTouchPriority(_priority - 40)
    _layer:addChild(bgMenu)

    --返回按钮
    local returnButton = CCMenuItemImage:create("images/common/close_btn_n.png","images/common/close_btn_h.png")
    returnButton:setScale(g_fElementScaleRatio)
    returnButton:setAnchorPoint(ccp(0.5,0.5))
    returnButton:setPosition(ccp(g_winSize.width*585/640,g_winSize.height*905/960))
    returnButton:registerScriptTapHandler(closeCallBack)
    bgMenu:addChild(returnButton)
end

function closeCallBack()
    AudioUtil.playEffect("audio/effect/guanbi.mp3")
    if not tolua.isnull(_layer) then
        _layer:removeFromParentAndCleanup(true)
    end
end

function refreshExploitsLabel( ... )
    if _exploitsLabel == nil then
        -- local exploitsBg = CCScale9Sprite:create("images/recharge/vip_benefit/desButtom.png")
        --    exploitsBg:setContentSize(CCSizeMake(290,55))
        --    exploitsBg:setAnchorPoint(ccp(0.5,1))
        --    exploitsBg:setPosition(ccp(g_winSize.width/2,g_winSize.height*750/960))
        --    exploitsBg:setScale(g_fElementScaleRatio)
        --    _layer:addChild(exploitsBg)

        --战功
        local x = 150
        local y = _viewBgSprite:getContentSize().height + 20
        local exploitsTitle = CCRenderLabel:create(GetLocalizeStringBy("key_10101"), g_sFontPangWa, 25, 1, ccc3( 0x00, 0x00, 0x00), type_shadow)
        _viewBgSprite:addChild(exploitsTitle)
        exploitsTitle:setColor(ccc3(0xff,0xf6,0x00))
        exploitsTitle:setAnchorPoint(ccp(0, 0.5))
        exploitsTitle:setPosition(ccp(x, y))
        --图标
        x = x + exploitsTitle:getContentSize().width
        local exploitsIcon = CCSprite:create("images/guild_boss_copy/exploits_icon.png")
        _viewBgSprite:addChild(exploitsIcon)
        exploitsIcon:setAnchorPoint(ccp(0, 0.5))
        exploitsIcon:setPosition(ccp(x,y))
        --战功值
        x = x + exploitsIcon:getContentSize().width
        _exploitsLabel = CCRenderLabel:create("", g_sFontPangWa, 25, 1, ccc3(0x00, 0x00, 0x00), type_shadow)
        _viewBgSprite:addChild(_exploitsLabel, 1)
        _exploitsLabel:setAnchorPoint(ccp(0, 0.5))
        _exploitsLabel:setPosition(ccp(x, y))
        _exploitsLabel:setColor(ccc3(0x00, 0xff, 0x18))
    end
    _exploitsLabel:setString(tostring(GuildDataCache.getExploitsCount()))
end

function loadTableView()
    --tableView背景
    local viewBgSprite = CCScale9Sprite:create(CCRectMake(50,50,6,4),"images/common/bg/9s_1.png")
    viewBgSprite:setContentSize(CCSizeMake(448 , _centerSize.height / MainScene.elementScale - 170))
    viewBgSprite:setAnchorPoint(ccp(1, 1))
    viewBgSprite:setPosition(ccp(g_winSize.width-10*g_fScaleX, _centerSize.height - 120 * MainScene.elementScale))
    _centerLayer:addChild(viewBgSprite)
    viewBgSprite:setScale(MainScene.elementScale)
    _viewBgSprite = viewBgSprite
    local shopInfo = GuildBossCopyData.getShopInfo()
    local h = LuaEventHandler:create(function(fn,p_table,a1,a2)
        local r
        if fn == "cellSize" then
            r = _cellSize
        elseif fn == "cellAtIndex" then
            a2 = createCell(a1 + 1)
            r = a2
        elseif fn == "numberOfCells" then
            r = table.count(DB_GroupCopy_shop.GroupCopy_shop)
        else
        end
        return r
    end)

    _tableView = LuaTableView:createWithHandler(h, CCSizeMake(_cellSize.width, viewBgSprite:getContentSize().height - 10))
    viewBgSprite:addChild(_tableView)
    _tableView:setVerticalFillOrder(kCCTableViewFillTopDown)
    _tableView:setAnchorPoint(ccp(0.5, 0.5))
    _tableView:setPosition(ccpsprite(0.5, 0.5, viewBgSprite))
    _tableView:ignoreAnchorPointForPosition(false)
    _tableView:setTouchPriority(_priority - 2)
end


function refreshUIByCell()
    refreshLabel()
    local offset = _exTableView:getContentOffset()
    _exTableView:reloadData()
    _exTableView:setContentOffset(offset)
    --_exTableView:updateCellAtIndex(GodShopCell.getSelectedTag()-1)
end

function createCell( p_index )
    local goodsId = p_index
    local groupCopyShopDb = DB_GroupCopy_shop.getDataById(goodsId)
    local shopInfo = GuildBossCopyData.getShopInfo()
    local goodInfo = shopInfo[tostring(goodsId)]

    local cell = CCTableViewCell:create()
    cell:setContentSize(_cellSize)
    --背景图片
    --local cellBgSprite = CCScale9Sprite:create("images/reward/cell_back.png")
    local cellBgSprite = CCScale9Sprite:create(CCRectMake(50, 50, 10, 10), "images/common/bg/bg_1.png")
    cellBgSprite:setContentSize(CCSizeMake(435,172))
    cellBgSprite:setAnchorPoint(ccp(0.5, 0.5))
    cellBgSprite:setPosition(ccpsprite(0.5, 0.5, cell))
    cell:addChild(cellBgSprite)

    --二级背景图片
    local innerBgSprite = CCScale9Sprite:create("images/copy/fort/textbg.png")
    innerBgSprite:setContentSize(CCSizeMake(250,120))
    innerBgSprite:setAnchorPoint(ccp(0,0))
    innerBgSprite:setPosition(ccp(25,37))
    cellBgSprite:addChild(innerBgSprite)


    --显示菜单栏回调
    local showDownMenu = function()
        MainScene.setMainSceneViewsVisible(false,false,false)
    end
    local rewardInDb = ItemUtil.getItemsDataByStr(groupCopyShopDb.item)
    local icon,itemName,itemColor = ItemUtil.createGoodsIcon(rewardInDb[1], _priority - 50, _zOrder + 10, nil,showDownMenu,nil,nil,false)
    icon:setPosition(10,20)
    innerBgSprite:addChild(icon)

    ------名称
    local nameLabel = CCRenderLabel:create(itemName, g_sFontPangWa,24,1,ccc3( 0x00, 0x00, 0x00),type_stroke)
    innerBgSprite:addChild(nameLabel)
    nameLabel:setAnchorPoint(ccp(0,0))
    nameLabel:setColor(itemColor)
    nameLabel:setPosition(ccp(110, innerBgSprite:getContentSize().height*0.65))

    local richInfo = {
        lineAlignment = 2,
        labelDefaultColor = ccc3(0xff, 0xf6, 0x00),
        labelDefaultSize = 18,
        defaultType = "CCRenderLabel",
        elements = {
            {
                ["type"] = "CCSprite",
                image = "images/guild_boss_copy/exploits_icon.png",
            },
            {
                text = parseField(groupCopyShopDb.price, 1)[3],
                color = ccc3(0xff, 0xff, 0xff),
            }
        }
    }
    local priceLabel = GetLocalizeLabelSpriteBy_2(GetLocalizeStringBy("key_10102"), richInfo)
    innerBgSprite:addChild(priceLabel)
    priceLabel:setAnchorPoint(ccp(0, 0.5))
    priceLabel:setPosition(ccp(110, innerBgSprite:getContentSize().height*0.45))

    local exploitsLimitText = nil
    --获取通关副本等级限制
    local groupCopyLimit = groupCopyShopDb.copy_limit
    local color = nil
    --如果玩家等级大于限制等级
    if GuildBossCopyData.isPassedGroupCopy(groupCopyLimit) then
        local limitType = groupCopyShopDb.type
        print("goodInfo.remain")
        print(goodInfo.remain)
        if limitType == 1 then
            exploitsLimitText = string.format(GetLocalizeStringBy("key_10103"), goodInfo.remain)  --今日
        elseif limitType == 2 then
            exploitsLimitText = string.format(GetLocalizeStringBy("key_10104"), goodInfo.remain)  --本周
        elseif limitType == 3 then
            exploitsLimitText = string.format(GetLocalizeStringBy("key_10105"), goodInfo.remain)  --总共
        end
        color = ccc3(0x00, 0xff, 0x18)
    else
        print("groupCopyLimit:")
        print(groupCopyLimit)
        local groupCopyDb = DB_GroupCopy.getDataById(groupCopyLimit)
        exploitsLimitText = string.format(GetLocalizeStringBy("key_10106"), groupCopyLimit, groupCopyDb.des) --需通关第几章
        color = ccc3(0xff, 0x8a, 0x00)
    end

    local exploitsLimitLabel = CCRenderLabel:create(exploitsLimitText, g_sFontName, 18, 1, ccc3( 0x00, 0x00, 0x00), type_shadow)
    cellBgSprite:addChild(exploitsLimitLabel)
    exploitsLimitLabel:setAnchorPoint(ccp(0, 0.5))
    exploitsLimitLabel:setPosition(ccp(30, 30))
    exploitsLimitLabel:setColor(color)

    local levelLimit = groupCopyShopDb.limit_lv
    if levelLimit > UserModel.getHeroLevel() then
        local richInfo = {
            labelDefaultFont = g_sFontPangWa,
            labelDefaultColor = ccc3(0x78,0x25,0x00),
            labelDefaultSize = 21,
            elements = {
                {
                    text = levelLimit,
                    color = ccc3(0x00, 0x8d, 0x3d)
                }
            }
        }
        local levelLimitLabel = GetLocalizeLabelSpriteBy_2(GetLocalizeStringBy("key_10142"), richInfo)
        cellBgSprite:addChild(levelLimitLabel)
        levelLimitLabel:setAnchorPoint(ccp(1, 0.5))
        levelLimitLabel:setPosition(ccp(cellBgSprite:getContentSize().width - 30, 30))
    end

    --按钮层
    local cellMenu = CCMenu:create()
    cellMenu:setAnchorPoint(ccp(0,0))
    cellMenu:setPosition(ccp(0,0))
    cellMenu:setTouchPriority(_priority - 1)
    cellBgSprite:addChild(cellMenu)

    --按钮位置
    local btnPosX = (cellBgSprite:getContentSize().width + innerBgSprite:getContentSize().width)/2

    --兑换按钮
    local exchangeMenuItem = LuaCC.create9ScaleMenuItemWithoutLabel("images/common/btn/btn_blue_n.png","images/common/btn/btn_blue_h.png","images/common/btn/btn_blue_hui.png",
        CCSizeMake(120,65))
    exchangeMenuItem:setAnchorPoint(ccp(0.5,0.5))
    exchangeMenuItem:setPosition(ccp(btnPosX,50 + innerBgSprite:getContentSize().height/2))
    exchangeMenuItem:registerScriptTapHandler(buyBtnCb)
    cellMenu:addChild(exchangeMenuItem,1, p_index)

    --“兑换”字
    local buyLabel = CCRenderLabel:create(GetLocalizeStringBy("key_2689"),g_sFontPangWa,30,1,ccc3(0x00,0x00,0x00),type_stroke)
    buyLabel:setColor(ccc3(0xff,0xe4,0x00))
    buyLabel:setAnchorPoint(ccp(0.5,0.5))
    buyLabel:setPosition(ccp(exchangeMenuItem:getContentSize().width *0.5,exchangeMenuItem:getContentSize().height *0.5))
    exchangeMenuItem:addChild(buyLabel)

    if goodInfo.remain == 0 or not GuildBossCopyData.isPassedGroupCopy(groupCopyLimit) then
        -- exchangeMenuItem:setEnabled(false)
        -- buyLabel:setColor(ccc3(0x88, 0x88, 0x88))
        exchangeMenuItem:setVisible(false)
        local hasReceiveItem = CCSprite:create("images/common/yiduihuan.png")
        hasReceiveItem:setAnchorPoint(ccp(0.5,0.5))
        hasReceiveItem:setPosition(ccp(btnPosX,50 + innerBgSprite:getContentSize().height/2))
        cellBgSprite:addChild(hasReceiveItem)
    end

    --多少多少级之后能增加兑换次数的label
    if(groupCopyShopDb.level_num ~= nil)then
        local _number,_level = GuildBossCopyData.getLevelnumber(groupCopyShopDb)
        if(_level ~= -1)then
            local _number,_level = GuildBossCopyData.getLevelnumber(groupCopyShopDb)
            local needLvLabel = CCLabelTTF:create(_level, g_sFontPangWa, 25)  --级别
            needLvLabel:setColor(ccc3(0x78, 0x25, 0x00))
            needLvLabel:setAnchorPoint(ccp(0,0))
            needLvLabel:setPosition(320, 20)
            cellBgSprite:addChild(needLvLabel)
            local lvLabel = CCLabelTTF:create(GetLocalizeStringBy("fqq_001"),g_sFontPangWa, 20)  --级可增加兑换次数
            lvLabel:setColor(ccc3(0x78, 0x25, 0x00))
            lvLabel:setAnchorPoint(ccp(0,0))
            lvLabel:setPosition(needLvLabel:getPositionX()+needLvLabel:getContentSize().width, 20)
            cellBgSprite:addChild(lvLabel)
        end
    else
    end
    return cell
end

function buyBtnCb(p_tag)
    AudioUtil.playEffect("audio/effect/zhujiemian.mp3")
    if ItemUtil.isBagFull() then
        return
    end
    local index = p_tag
    print("index:")
    print(index)
    local groupCopyShopDb = DB_GroupCopy_shop.getDataById(index)
    if UserModel.getHeroLevel() < groupCopyShopDb.limit_lv then
        AnimationTip.showTip(string.format(GetLocalizeStringBy("key_10143"), groupCopyShopDb.limit_lv))  --该物品需要人物等级达到%d级才可兑换"
        return
    end
    local priceInfo = parseField(groupCopyShopDb.price, 1)
    local shopInfo = GuildBossCopyData.getShopInfo()
    local goodInfo = shopInfo[tostring(groupCopyShopDb.id)]

    require "script/ui/common/BatchExchangeLayer"
    local paramTable = {}
    paramTable.title = GetLocalizeStringBy("key_2342")   --兑换道具
    paramTable.first = GetLocalizeStringBy("key_1438")  --请选择兑换
    paramTable.max = goodInfo.remain
    paramTable.name = ItemUtil.getItemNameByItmTid(parseField(groupCopyShopDb.item, 1)[2])
    paramTable.need = {}
    local localTable = {
        needName = GetLocalizeStringBy("key_10107"), --"需要战功:",
        sprite = "images/guild_boss_copy/exploits_icon.png",
        price = priceInfo[3]
    }
    table.insert(paramTable.need,localTable)

    local sureCallBack = function ( p_buyNum )
        local cost = priceInfo[3] * p_buyNum
        if cost > GuildDataCache.getExploitsCount() then
            AnimationTip.showTip(GetLocalizeStringBy("key_10108"))
            return
        end
        local buyCallFunc = function (  )
            GuildDataCache.addExploitsCount(-cost)
            refreshExploitsLabel()
            _tableView:updateCellAtIndex(index - 1)
            require "script/ui/item/ReceiveReward"
            local itemsData = ItemUtil.getItemsDataByStr(groupCopyShopDb.item)
            itemsData[1].num = p_buyNum * itemsData[1].num
            ReceiveReward.showRewardWindow(itemsData, nil, nil, _priority - 50)
        end
        GuildBossCopyService.buy(buyCallFunc, groupCopyShopDb.id, p_buyNum)
    end
    BatchExchangeLayer.showBatchLayer(paramTable, sureCallBack, _priority - 50)
end






